metadata:
  version: spray-v2.18.0a-8_k8s-v1.23.6_v1.13-arm64
  type: kubernetes-offline-resource
  kuboard_spray_version:
    min: v1.1.0
  available_at:
    - registry.cn-shanghai.aliyuncs.com/kuboard-spray/kuboard-spray-resource
    - swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard-spray-resource
    - eipwork/kuboard-spray-resource
  issue_date: "2022-05-01"
  owner: "shaohq@foxmail.com"
  can_upgrade_from:
    include:
      - spray-v2.18.[0-9a-]*_k8s-v1.23.[1-5]_v[0-9.]*-arm64
      - spray-master-8d9ed01_k8s-v1.23.[1-3]_v[0-9.]*-arm64
    exclude:
  can_replace_to:
  supported_os:
    - distribution: Ubuntu
      versions:
        - "20.04"
    - distribution: Anolis
      versions:
        - "8.5" 
        - "8.4" 
    - distribution: CentOS
      versions:
        - "7.6"
        - "7.8"
        - "7.9"
        - "8"
    - distribution: RedHat
      versions:
        - "7.9"
        - "8.5"
    - distribution: OracleLinux
      versions:
        - "8.5"
    - distribution: Rocky
      versions:
        - "8.5"
    - distribution: openEuler
      versions:
        - "20.03"
        - "22.03"
    - distribution: Kylin Linux Advanced Server
      versions:
        - "V10"
    - distribution: openSUSE Leap
      versions:
        - "15.3"

data:
  kubespray_version: v2.18.0a-8
  supported_playbooks:
    install_cluster: pb_cluster.yaml
    remove_node: pb_remove_node.yaml
    add_node: pb_scale.yaml
    sync_nginx_config: pb_sync_nginx_config.yaml
    sync_etcd_address: pb_sync_etcd_address.yaml
    install_addon: pb_install_addon.yaml
    remove_addon: pb_remove_addon.yaml
    cluster_version_containerd: pb_cluster_version_containerd.yaml
    cluster_version_docker: pb_cluster_version_docker.yaml
    upgrade_cluster: pb_upgrade_cluster.yaml
    drain_node: pb_drain_node.yaml
    uncordon_node: pb_uncordon_node.yaml
    cis_scan: true # 只在此属性为 true 的时候激活 CIS 扫描
    renew_cert: pb_renew_cert.yaml
    sync_container_engine_params: pb_sync_container_engine_params.yaml
    backup_etcd: pb_backup_etcd.yaml
    restore_etcd: pb_restore_etcd.yaml

  kubernetes:
    kube_version: "v1.23.6"
    image_arch: arm64
    gcr_image_repo: "gcr.io"
    kube_image_repo: "k8s.gcr.io"
    candidate_admission_plugins: AlwaysAdmit,AlwaysDeny,CertificateApproval,CertificateSigning,CertificateSubjectRestriction,DefaultIngressClass,DefaultStorageClass,DefaultTolerationSeconds,DenyServiceExternalIPs,EventRateLimit,ExtendedResourceToleration,ImagePolicyWebhook,LimitPodHardAntiAffinityTopology,LimitRanger,MutatingAdmissionWebhook,NamespaceAutoProvision,NamespaceExists,NamespaceLifecycle,NodeRestriction,OwnerReferencesPermissionEnforcement,PersistentVolumeClaimResize,PersistentVolumeLabel,PodNodeSelector,PodSecurity,PodTolerationRestriction,Priority,ResourceQuota,RuntimeClass,SecurityContextDeny,ServiceAccount,StorageObjectInUseProtection,TaintNodesByCondition,ValidatingAdmissionWebhook
    default_enabled_admission_plugins: CertificateApproval,CertificateSigning,CertificateSubjectRestriction,DefaultIngressClass,DefaultStorageClass,DefaultTolerationSeconds,LimitRanger,MutatingAdmissionWebhook,NamespaceLifecycle,PersistentVolumeClaimResize,Priority,ResourceQuota,RuntimeClass,ServiceAccount,StorageObjectInUseProtection,TaintNodesByCondition,ValidatingAdmissionWebhook

  container_engine:
    - container_manager: "containerd"
      params:
        containerd_version: 1.6.2
    - container_manager: "docker"
      params:
        docker_version: "20.10"
        docker_containerd_version: 1.4.12

  vars:
    target:
      containerd_version: 1.6.2
      etcd_version: v3.5.3
      kubelet_checksums:
        arm64:
          v1.23.6: 11a0310e8e7af5a11539ac26d6c14cf1b77d35bce4ca74e4bbd053ed1afc8650
        amd64:
          v1.23.6: fbb83e35f6b9f7cae19c50694240291805ca9c4028676af868306553b3e9266c
      kubectl_checksums:
        arm64:
          v1.23.6: 4be771c8e6a082ba61f0367077f480237f9858ef5efe14b1dbbfc05cd42fc360
        amd64:
          v1.23.6: 703a06354bab9f45c80102abff89f1a62cbc2c6d80678fd3973a014acc7c500a
      kubeadm_checksums:
        arm64:
          v1.23.6: a4db7458e224c3a2a7b468fc2704b31fec437614914b26a9e3d9efb6eecf61ee
        amd64:
          v1.23.6: 9213c7d738e86c9a562874021df832735236fcfd5599fd4474bab3283d34bfd7
      crun_checksums:
        arm64:
          1.4.4: 2ad2c02ec0b1566f1c5e85223b726b704904cc75c2eb4af298e95b98fe5c166d
        amd64:
          1.4.4: 73f7f89a98f69c0bf0e9fe1e0129201d5b72529785b4b1bcb4d43c31d0c3a8ea
      runc_checksums:
        arm64:
          v1.1.1: 20c436a736547309371c7ac2a335f5fe5a42b450120e497d09c8dc3902c28444
        amd64:
          v1.1.1: 5798c85d2c8b6942247ab8d6830ef362924cd72a8e236e77430c3ab1be15f080
      containerd_archive_checksums:
        arm64:
          1.6.2: a4b24b3c38a67852daa80f03ec2bc94e31a0f4393477cd7dc1c1a7c2d3eb2a95
        amd64:
          1.6.2: 3d94f887de5f284b0d6ee61fa17ba413a7d60b4bb27d756a402b713a53685c6a
      nerdctl_archive_checksums:
        arm64:
          0.18.0: 4f73a20d4872da3771a1f7088cae707bf119d35c2e97ea33c9d31b9d167ad956
        amd64:
          0.18.0: ea44e112d3365c8d86f9189b6fae250767e383dfa7c01a8c05f3de2a7b7c8720
      etcd_binary_checksums:
        arm64:
          v3.5.3: 8b00f2f51568303799368ee4a3c9b9ff8a3dd9f8b7772c4f6589e46bc62f7115
        amd64:
          v3.5.3: e13e119ff9b28234561738cd261c2a031eb1c8688079dcf96d8035b3ad19ca58
      dns_min_replicas: "{{ [ 2, groups['kube_control_plane'] | length ] | min }}"
      kuboardspray_extra_downloads:
        kuboard:
          container: true
          file: false
          enabled: "{{ kuboard_enabled }}"
          version: "{{ kuboard_version }}"
          repo: "eipwork/kuboard"
          tag: "{{ kuboard_version }}"
          sha256: ""
          groups:
            - kube_control_plane
        netcheck_etcd:
          container: true
          file: false
          enabled: "{{ deploy_netchecker }}"
          version: "{{ netcheck_etcd_image_tag }}"
          dest: "{{ local_release_dir }}/etcd-{{ netcheck_etcd_image_tag }}-linux-{{ image_arch }}.tar.gz"
          repo: "{{ etcd_image_repo }}"
          tag: "{{ netcheck_etcd_image_tag }}"
          sha256: >-
            {{ etcd_digest_checksum|d(None) }}
          unarchive: false
          owner: "root"
          mode: "0755"
          groups:
            - k8s_cluster
        coredns:
          enabled: "{{ dns_mode in ['coredns', 'coredns_dual'] }}"
          container: true
          repo: "{{ coredns_image_repo }}"
          tag: "{{ coredns_image_tag }}"
          sha256: "{{ coredns_digest_checksum|default(None) }}"
          groups:
            - k8s_cluster

  etcd:
    etcd_version: v3.5.3
    etcd_params:
    etcd_deployment_type:
      - "host"
      - "docker"
  dependency:
    - name: crun
      version: 1.4.4
      target: crun_version
    - name: runc
      version: v1.1.1
      target: runc_version
    - name: cni-plugins
      version: "v1.0.1"
      target: cni_version
    - name: crictl
      version: "v1.23.0"
      target: crictl_version
    - name: nerdctl
      version: "0.18.0"
      target: nerdctl_version
    - name: nginx_image
      version: 1.21.4
      target: nginx_image_tag
    - name: coredns
      target: coredns_version
      version: "v1.8.6"
    - name: cluster-proportional-autoscaler
      target: dnsautoscaler_version
      version: 1.8.5
    - name: pause
      target: pod_infra_version
      version: "3.6"
  network_plugin:
    - name: calico
      params:
        calico_version: "v3.21.4"
    - name: flannel
      params:
        flannel_version: "v0.15.1"
        flannel_cni_version: "v1.0.0"
  addon:
    - name: kuboard
      target: kuboard_enabled
      lifecycle:
        install_by_default: true
        check:
          shell: "kubectl get pods -n kuboard -l k8s.kuboard.cn/name=kuboard-v3"
          keyword: 'kuboard-v3'
        install_addon_tags:
          - download
          - upgrade
          - kuboard
        remove_addon_tags:
          - upgrade
          - kuboard
        downloads:
          - kuboard
      params_default:
        kuboard_version: 'v3.4.1.0'
        kuboard_port: 80
        kuboard_cluster_name: 'default'
        kuboard_data_dir: '/root/kuboard-data'
      params:
    - name: nodelocaldns
      target: enable_nodelocaldns
      lifecycle:
        install_by_default: true
        check:
          shell: "kubectl get daemonset -n kube-system nodelocaldns -o json"
          keyword: '"k8s-app": "kube-dns"'
        install_addon_tags:
          - download
          - upgrade
          - coredns
          - nodelocaldns
        downloads:
          - nodelocaldns
          - coredns
      params:
        nodelocaldns_version: "1.21.1"
        enable_nodelocaldns_secondary: false
    # - name: netchecker
    #   target: deploy_netchecker
    #   lifecycle:
    #     install_by_default: true
    #     check:
    #       shell: "kubectl get deployment -n {{ netcheck_namespace | default('default') }} netchecker-server -o json"
    #       keyword: "k8s-netchecker-server"
    #     install_addon_tags:
    #       - download
    #       - upgrade
    #       - netchecker
    #     remove_addon_tags:
    #       - upgrade
    #       - netchecker
    #     downloads:
    #       - netcheck_server
    #       - netcheck_agent
    #       - netcheck_etcd
    #   params:
    #     netcheck_version: "v1.2.2"
    #     netcheck_agent_image_repo: "{{ docker_image_repo }}/mirantis/k8s-netchecker-agent"
    #     netcheck_agent_image_tag: "{{ netcheck_version }}"
    #     netcheck_server_image_repo: "{{ docker_image_repo }}/mirantis/k8s-netchecker-server"
    #     netcheck_server_image_tag: "{{ netcheck_version }}"
    #     netcheck_etcd_image_tag: "v3.5.3"
    # - name: helm
    #   install_by_default: false
    #   target: helm_enabled
    #   params:
    #     helm_version: "v3.7.1"
    - name: metrics_server
      target: metrics_server_enabled
      lifecycle:
        install_by_default: true
        check:
          shell: "kubectl get deployments -n kube-system metrics-server -o json"
          keyword: "k8s.gcr.io/metrics-server/metrics-server"
        install_addon_tags:
          - download
          - upgrade
          - metrics_server
        remove_addon_tags:
          - upgrade
          - metrics_server
        downloads:
          - metrics_server
      params:
        metrics_server_version: "v0.5.2"
    # - name: cephfs_provisioner
    #   install_by_default: false
    #   target: cephfs_provisioner_enabled
    #   params:
    #     csi_attacher_image_repo: "{{ kube_image_repo }}/sig-storage/csi-attacher"
    #     csi_attacher_image_tag: "v3.3.0"
    #     csi_provisioner_image_repo: "{{ kube_image_repo }}/sig-storage/csi-provisioner"
    #     csi_provisioner_image_tag: "v3.0.0"
    #     csi_snapshotter_image_repo: "{{ kube_image_repo }}/sig-storage/csi-snapshotter"
    #     csi_snapshotter_image_tag: "v4.2.1"
    #     csi_resizer_image_repo: "{{ kube_image_repo }}/sig-storage/csi-resizer"
    #     csi_resizer_image_tag: "v1.3.0"
    #     csi_node_driver_registrar_image_repo: "{{ kube_image_repo }}/sig-storage/csi-node-driver-registrar"
    #     csi_node_driver_registrar_image_tag: "v2.4.0"
    #     csi_livenessprobe_image_repo: "{{ kube_image_repo }}/sig-storage/livenessprobe"
    #     csi_livenessprobe_image_tag: "v2.5.0"
    # - name: local_path_provisioner
    #   install_by_default: false
    #   target: local_path_provisioner_enabled
    #   params:
    #     local_path_provisioner_image_tag: "v0.0.19"
